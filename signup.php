<?php
require_once('function.php');

	$signup = new users;
	extract($_POST);
//$username = preg_replace('/[^a-zA-Z ]/', '', $name);
//$user_Fname = ucfirst(trim($username));
//$name = str_split($name);
	$name = $_POST['name'];
	$newname=explode(' ',$name);
	$fname=$newname[0];
	//print_r($newname);
	$lname ="";
	for($i=1; $i<sizeof($newname); $i++)
		{
			$lname .= " $newname[$i]";
		}	
	$userfname = preg_replace('/[^a-zA-Z ]/', '', $fname);
	$firstname = ucfirst(trim($userfname));
	//$lname=$name[1];
	//$lname = end($name);
	$userlname = preg_replace('/[^a-zA-Z ]/', '', $lname);
	$lastname = ucfirst(trim($userlname));
	$pass = $_POST['password'];
	$newPass = md5($pass);
	$admission_date = date('Y-m-d H:i:s',strtotime('+330 minutes'));

	$captcha=$_POST['g-recaptcha-response'];
        if(!$captcha){
        	header('Location: http://localhost/visionopentest/index.php?ref=register');
			echo "<script type='text/javascript'>";
            echo "alert('Please Check the recaptcha field')";
		    echo "</script>";
			exit;
        }
        $secretKey = "6Lf8pGwUAAAAAI5V7dG9r8QVLxhhQ6gCj2PyKj3S";
        $ip = $_SERVER['REMOTE_ADDR'];
        $response=file_get_contents("https://www.google.com/recaptcha/api/siteverify?secret=".$secretKey."&response=".$captcha."&remoteip=".$ip);
        $responseKeys = json_decode($response,true);
        if(intval($responseKeys["success"]) !== 1) {
        	header('Location: http://localhost/visionopentest/index.php?ref=register');
			echo "<script type='text/javascript'>";
            echo "alert('Recaptcha fail, Please try again')";
		    echo "</script>";
		    exit;
        }
        
		//New user insert
		$query = "INSERT INTO members (firstname, lastname, email, telephone_local, password, admission_date) VALUES ('$firstname','$lastname','$email',$phone,'$newPass','$admission_date')";

		if($signup->signup($query))
		{
					
		?>
		<?php
			$signup->url("index.php?verify=1");
		}

	?>